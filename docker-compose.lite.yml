# Lightweight deployment - just webapp and auth-server
# Perfect for Raspberry Pi and development

services:
  # Main web application
  webapp:
    image: webapp-webapp:latest
    container_name: webapp
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - SESSION_SECRET=${SESSION_SECRET:-change-this-secret}
      # OAuth endpoints pointing to auth-server
      - OAUTH_CLIENT_ID=webapp-client
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET:-webapp-secret}
      - OAUTH_AUTH_URL=http://auth-server:4000/oauth/authorize
      - OAUTH_TOKEN_URL=http://auth-server:4000/oauth/token
      - OAUTH_USERINFO_URL=http://auth-server:4000/oauth/userinfo
      - OAUTH_CALLBACK_URL=http://localhost:3000/auth/callback
      # For external redirects, use host IP
      - EXTERNAL_AUTH_URL=http://${EXTERNAL_IP:-localhost}:4000
    volumes:
      - webapp-data:/app/data
      - webapp-logs:/app/logs
    depends_on:
      - auth-server
    networks:
      - auth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Custom OAuth2 server
  auth-server:
    image: webapp-auth-server:latest
    container_name: auth-server
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
    volumes:
      - auth-data:/app/data
    networks:
      - auth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  webapp-data:
  webapp-logs:
  auth-data:

networks:
  auth-network:
    driver: bridge