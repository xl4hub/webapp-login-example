version: '3.8'

services:
  # Main web application
  webapp:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: webapp
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - SESSION_SECRET=${SESSION_SECRET:-change-this-secret}
      # OAuth endpoints pointing to internal services
      - OAUTH_AUTH_URL=http://auth-server:4000/oauth/authorize
      - OAUTH_TOKEN_URL=http://auth-server:4000/oauth/token
      - OAUTH_USERINFO_URL=http://auth-server:4000/oauth/userinfo
      - OAUTH_CALLBACK_URL=http://localhost:3000/auth/callback
      # External-facing URLs for redirects
      - EXTERNAL_AUTH_URL=${EXTERNAL_URL:-http://localhost}:4000
      # Logto OAuth configuration
      - LOGTO_CLIENT_ID=${LOGTO_CLIENT_ID}
      - LOGTO_CLIENT_SECRET=${LOGTO_CLIENT_SECRET}
      - LOGTO_AUTH_URL=${LOGTO_AUTH_URL}
      - LOGTO_TOKEN_URL=${LOGTO_TOKEN_URL}
      - LOGTO_USERINFO_URL=${LOGTO_USERINFO_URL}
      - LOGTO_CALLBACK_URL=${LOGTO_CALLBACK_URL}
      # Casdoor OAuth configuration
      - CASDOOR_CLIENT_ID=${CASDOOR_CLIENT_ID}
      - CASDOOR_CLIENT_SECRET=${CASDOOR_CLIENT_SECRET}
      - CASDOOR_AUTH_URL=${CASDOOR_AUTH_URL}
      - CASDOOR_TOKEN_URL=${CASDOOR_TOKEN_URL}
      - CASDOOR_USERINFO_URL=${CASDOOR_USERINFO_URL}
      - CASDOOR_CALLBACK_URL=${CASDOOR_CALLBACK_URL}
    volumes:
      - webapp-data:/app/data
      - webapp-logs:/app/logs
    depends_on:
      - auth-server
    networks:
      - auth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Custom OAuth2 server
  auth-server:
    build:
      context: ./auth-server
      dockerfile: Dockerfile
    container_name: auth-server
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
    volumes:
      - auth-data:/app/data
    networks:
      - auth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MySQL for Casdoor
  casdoor-mysql:
    image: mysql:8.0
    container_name: casdoor-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${CASDOOR_DB_ROOT_PASSWORD:-root_password}
      MYSQL_DATABASE: casdoor
      MYSQL_USER: casdoor
      MYSQL_PASSWORD: ${CASDOOR_DB_PASSWORD:-casdoor_password}
    volumes:
      - casdoor-mysql-data:/var/lib/mysql
    networks:
      - auth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${CASDOOR_DB_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Casdoor identity server (optional - comment out if not using)
  casdoor:
    image: casbin/casdoor:v1.541.0
    container_name: casdoor
    ports:
      - "8000:8000"
    environment:
      - RUNNING_IN_DOCKER=true
    volumes:
      - ./config/casdoor/app.conf:/conf/app.conf:ro
      - ./config/casdoor/init_data.json:/conf/init_data.json:ro
    networks:
      - auth-network
    restart: unless-stopped
    depends_on:
      casdoor-mysql:
        condition: service_healthy

  # PostgreSQL for Logto
  logto-postgres:
    image: postgres:15-alpine
    container_name: logto-postgres
    environment:
      POSTGRES_USER: logto
      POSTGRES_PASSWORD: ${LOGTO_DB_PASSWORD:-logto_password}
      POSTGRES_DB: logto
    volumes:
      - logto-postgres-data:/var/lib/postgresql/data
    networks:
      - auth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U logto -d logto"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Logto identity platform (optional - comment out if not using)
  logto:
    image: svhd/logto:1.22.0
    container_name: logto
    ports:
      - "3001:3001"
      - "3002:3002"  # Admin console
    environment:
      - TRUST_PROXY_HEADER=true
      - DB_URL=postgresql://logto:${LOGTO_DB_PASSWORD:-logto_password}@logto-postgres:5432/logto
      - ENDPOINT=http://localhost:3001
      - ADMIN_ENDPOINT=http://localhost:3002
    networks:
      - auth-network
    restart: unless-stopped
    depends_on:
      logto-postgres:
        condition: service_healthy

  # Initialize Logto database (runs once)
  logto-db-init:
    image: svhd/logto:1.22.0
    container_name: logto-db-init
    entrypoint: ["sh", "-c", "npm run cli db seed -- --swe && npm run cli db alteration deploy latest"]
    environment:
      - DB_URL=postgresql://logto:${LOGTO_DB_PASSWORD:-logto_password}@logto-postgres:5432/logto
    networks:
      - auth-network
    depends_on:
      logto-postgres:
        condition: service_healthy

  # Logto seed script (creates webapp application and excelfore user)
  logto-seed:
    image: node:18-alpine
    container_name: logto-seed
    volumes:
      - ./config/logto/seed.js:/app/seed.js:ro
    working_dir: /app
    command: ["node", "seed.js"]
    environment:
      - LOGTO_ENDPOINT=http://logto:3001
    networks:
      - auth-network
    depends_on:
      - logto
    restart: "no"

  # Nginx reverse proxy (optional - for production)
  # nginx:
  #   image: nginx:alpine
  #   container_name: nginx-proxy
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./config/nginx:/etc/nginx/conf.d:ro
  #     - nginx-certs:/etc/nginx/certs
  #   depends_on:
  #     - webapp
  #     - auth-server
  #   networks:
  #     - auth-network
  #   restart: unless-stopped

volumes:
  webapp-data:
  webapp-logs:
  auth-data:
  casdoor-mysql-data:
  logto-postgres-data:
  nginx-certs:

networks:
  auth-network:
    driver: bridge